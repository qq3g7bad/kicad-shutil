#!/usr/bin/env bash

# @IMPL-MAIN-001@ (FROM: @ARCH-MAIN-001@)
# kicad-shutil - KiCad Project Helper Utilities
# Manage KiCad projects: verify libraries, symbols, footprints, and datasheets

set -uo pipefail

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"
CACHE_DIR="$SCRIPT_DIR/cache"

# Verbose mode (set via --verbose flag)
export VERBOSE=false

# Source library modules
source "$LIB_DIR/utils.sh"

# Usage information
usage() {
	cat <<EOF
Usage: kicad-shutil project <file.kicad_pro|directory>
       kicad-shutil <file.kicad_pro>              # Implicit project command
       kicad-shutil sym [options] <file.kicad_sym>...

KiCad Project Helper Utilities

COMMANDS:
    project          Verify KiCad project and all libraries
                     Run 'kicad-shutil project --help' for details

    sym              Manage symbol library files (.kicad_sym)
                     Run 'kicad-shutil sym --help' for details

GLOBAL OPTIONS:
    --verbose        Show detailed verbose output
    -h, --help       Show this help message
    -v, --version    Show version information

EXAMPLES:
    # Verify entire project (explicit)
    kicad-shutil project my_project.kicad_pro
    kicad-shutil project ./my_project

    # Verify project (implicit - auto-detect .kicad_pro)
    kicad-shutil my_project.kicad_pro

    # Verify project with verbose output
    kicad-shutil --verbose project my_project.kicad_pro

    # Manage symbol libraries
    kicad-shutil sym pmic.kicad_sym
    kicad-shutil sym --update-digikey pmic.kicad_sym
    kicad-shutil sym --download-datasheets pmic.kicad_sym --to ~/datasheets

EOF
	exit 0
}

# Project command: verify a KiCad project
# Usage: usage_project [exit_code]
usage_project() {
	local exit_code="${1:-0}"
	cat <<EOF
Usage: kicad-shutil project [options] <directory|file.kicad_pro>
       kicad-shutil <file.kicad_pro>                # Implicit

Verify a KiCad project and all associated libraries.

This command performs comprehensive verification:
  • Validates project structure and library tables
  • Checks all symbol libraries for missing footprints and datasheets
  • Checks all footprint libraries for missing 3D models
  • Resolves all environment variables (KIPRJMOD, etc.)

OPTIONS:
    --verbose      Show detailed verbose output (INFO, OK, and summary)
    -h, --help     Show this help message

EXAMPLES:
    # Verify a project (by file)
    kicad-shutil project my_project.kicad_pro
    kicad-shutil my_project.kicad_pro              # Implicit

    # Verify a project (by directory)
    kicad-shutil project ./my_project

    # Verify with verbose output
    kicad-shutil --verbose project my_project.kicad_pro

EOF
	exit "$exit_code"
}

# Symbol command: manage symbol library files
# Usage: usage_sym [exit_code]
usage_sym() {
	local exit_code="${1:-0}"
	cat <<EOF
Usage: kicad-shutil sym [options] <file.kicad_sym> [<file2.kicad_sym> ...]

Manage KiCad symbol library files.

If no operation is specified, defaults to --verify.

OPTIONS:
    -v, --verify                Validate footprints, datasheets, and show detailed report
    -u, --update-digikey        Add/update DigiKey part numbers, URLs, and metadata
    -d, --delete-digikey        Remove all DigiKey metadata from symbols
    -D, --download-datasheets   Download all datasheets (use --to <dir> to specify directory)
    -t, --to <dir>              Target directory for datasheet downloads
    -h, --help                  Show this help message

EXAMPLES:
    # Verify symbol library (default operation)
    kicad-shutil sym pmic.kicad_sym
    kicad-shutil sym --verify pmic.kicad_sym

    # Add/update DigiKey info (interactive mode)
    kicad-shutil sym --update-digikey pmic.kicad_sym

    # Remove all DigiKey metadata
    kicad-shutil sym --delete-digikey pmic.kicad_sym

    # Download datasheets to specific directory
    kicad-shutil sym --download-datasheets *.kicad_sym --to ~/datasheets

EOF
	exit "$exit_code"
}

# @IMPL-MAIN-002@ (FROM: @ARCH-MAIN-001@)
# Parse command line and route to appropriate subcommand
main() {
	if [[ $# -eq 0 ]]; then
		usage
	fi

	local command="$1"

	# Handle special cases
	case "$command" in
		-h | --help | help)
			usage
			;;
		-v | --version)
			echo "kicad-shutil"
			exit 0
			;;
		--verbose)
			# Global verbose flag
			export VERBOSE=true
			shift
			main "$@"
			return $?
			;;
		project)
			# Explicit project subcommand
			shift
			cmd_project "$@"
			return $?
			;;
		sym)
			# Symbol library management
			shift
			cmd_sym "$@"
			return $?
			;;
		*.kicad_pro)
			# Implicit project command (auto-detect .kicad_pro files)
			cmd_project "$@"
			return $?
			;;
		*)
			error "Unknown command or option: $command"
			echo "" >&2
			echo "Use 'kicad-shutil --help' for usage information." >&2
			exit 2
			;;
	esac
}

# @IMPL-MAIN-003@ (FROM: @ARCH-MAIN-001@)
# Project command implementation
cmd_project() {
	local project_input=""
	local project_file=""

	# Parse arguments
	while [[ $# -gt 0 ]]; do
		case "$1" in
			-h | --help)
				usage_project
				;;
			--verbose)
				export VERBOSE=true
				shift
				;;
			-*)
				error "Unknown option for 'project' command: $1"
				echo "" >&2
				usage_project 2
				;;
			*)
				if [[ -z "$project_input" ]]; then
					project_input="$1"
				else
					error "Only one project path can be specified"
					exit 2
				fi
				shift
				;;
		esac
	done

	# Validate input
	if [[ -z "$project_input" ]]; then
		error "No project path specified"
		usage_project 2
	fi

	# Determine project file
	if [[ -d "$project_input" ]]; then
		# Input is a directory - find .kicad_pro file
		local pro_files=("$project_input"/*.kicad_pro)
		if [[ ${#pro_files[@]} -eq 0 || ! -f "${pro_files[0]}" ]]; then
			error "No .kicad_pro file found in directory: $project_input"
			exit 1
		fi
		if [[ ${#pro_files[@]} -gt 1 ]]; then
			error "Multiple .kicad_pro files found in directory: $project_input"
			echo "Please specify the project file directly" >&2
			exit 1
		fi
		project_file="${pro_files[0]}"
	elif [[ -f "$project_input" ]]; then
		# Input is a file
		if [[ ! "$project_input" =~ \.kicad_pro$ ]]; then
			error "File must be a .kicad_pro file: $project_input"
			exit 1
		fi
		project_file="$project_input"
	else
		error "Path not found: $project_input"
		exit 1
	fi

	# Initialize
	if ! init_utils; then
		exit 1
	fi
	mkdir -p "$CACHE_DIR"

	# Source verification modules
	source "$LIB_DIR/verify.sh"

	# Verify project
	verify_file "$project_file" ""
}

# @IMPL-MAIN-004@ (FROM: @ARCH-MAIN-001@)
# Symbol command implementation
cmd_sym() {
	# Source required modules
	source "$LIB_DIR/parser.sh"
	source "$LIB_DIR/writer.sh"

	local OPT_UPDATE_DIGIKEY=false
	local OPT_DELETE_DIGIKEY=false
	local OPT_VERIFY=false
	local OPT_DOWNLOAD_DATASHEETS=false
	local DATASHEET_DIR="./datasheets"
	local FILES=()

	# Parse arguments
	while [[ $# -gt 0 ]]; do
		case "$1" in
			-h | --help)
				usage_sym
				;;
			-u | --update-digikey)
				OPT_UPDATE_DIGIKEY=true
				shift
				;;
			-d | --delete-digikey)
				OPT_DELETE_DIGIKEY=true
				shift
				;;
			-v | --verify)
				OPT_VERIFY=true
				shift
				;;
			-D | --download-datasheets)
				OPT_DOWNLOAD_DATASHEETS=true
				shift
				;;
			-t | --to)
				DATASHEET_DIR="$2"
				shift 2
				;;
			-*)
				error "Unknown option: $1"
				usage_sym 2
				;;
			*)
				FILES+=("$1")
				shift
				;;
		esac
	done

	# Validate: at least one file
	if [[ ${#FILES[@]} -eq 0 ]]; then
		error "No input files specified"
		usage_sym 2
	fi

	# If no operation specified, default to --verify
	if ! $OPT_UPDATE_DIGIKEY && ! $OPT_DELETE_DIGIKEY && ! $OPT_VERIFY && ! $OPT_DOWNLOAD_DATASHEETS; then
		info "No operation specified, defaulting to --verify"
		OPT_VERIFY=true
	fi

	# Validate: can't use both update and delete at the same time
	if $OPT_UPDATE_DIGIKEY && $OPT_DELETE_DIGIKEY; then
		error "Cannot use --update-digikey and --delete-digikey together"
		exit 1
	fi

	# Expand glob patterns and validate files
	local expanded_files=()
	for pattern in "${FILES[@]}"; do
		if [[ -f "$pattern" ]]; then
			expanded_files+=("$pattern")
		else
			# Try glob expansion
			# shellcheck disable=SC2206
			local matches=($pattern)
			if [[ -e "${matches[0]}" ]]; then
				expanded_files+=("${matches[@]}")
			else
				warn "File not found: $pattern"
			fi
		fi
	done

	FILES=("${expanded_files[@]}")

	if [[ ${#FILES[@]} -eq 0 ]]; then
		error "No valid input files found"
		exit 1
	fi

	# Validate file extensions (only .kicad_sym allowed)
	for file in "${FILES[@]}"; do
		if [[ ! "$file" =~ \.kicad_sym$ ]]; then
			error "Unsupported file type: $file (only .kicad_sym files are supported)"
			exit 1
		fi
	done

	# Initialize
	if ! init_utils; then
		exit 1
	fi
	mkdir -p "$CACHE_DIR"

	# Initialize verify if needed
	if $OPT_VERIFY; then
		source "$LIB_DIR/verify.sh"
		init_verify_stats
	fi

	# Initialize datasheet if needed
	if $OPT_DOWNLOAD_DATASHEETS; then
		source "$LIB_DIR/datasheet.sh"
		init_datasheet_stats
		export DATASHEET_DIR
	fi

	# Initialize DigiKey if needed
	if $OPT_UPDATE_DIGIKEY || $OPT_DELETE_DIGIKEY; then
		source "$LIB_DIR/digikey.sh"
	fi

	info "kicad-shutil - Processing ${#FILES[@]} file(s)"

	# Process each file
	for file in "${FILES[@]}"; do
		if [[ ! -f "$file" ]]; then
			warn "Skipping non-existent file: $file"
			continue
		fi

		process_symbol_file "$file"
	done

	# Print verification report at the end (only in verbose mode)
	if $OPT_VERIFY && [[ "${VERBOSE:-false}" == "true" ]]; then
		print_verify_report
	fi

	# Print datasheet download summary (only in verbose mode)
	if $OPT_DOWNLOAD_DATASHEETS && [[ "${VERBOSE:-false}" == "true" ]]; then
		print_datasheet_summary
	fi

	info "Processing complete"
}

# @IMPL-MAIN-005@ (FROM: @ARCH-MAIN-001@)
# Process a single .kicad_sym file
process_symbol_file() {
	local file="$1"
	local filename
	filename=$(basename "$file")
	local category="${filename%.kicad_sym}"

	# Don't print info messages in TSV mode
	if [[ "${OUTPUT_TSV:-false}" != "true" ]]; then
		info "Processing: $filename"
	fi

	# Parse all symbols in the file
	local symbols_data
	symbols_data=$(parse_file "$file")

	if [[ -z "$symbols_data" ]]; then
		if [[ "${OUTPUT_TSV:-false}" != "true" ]]; then
			warn "  No symbols found in $filename"
		fi
		return
	fi

	# Count symbols
	local symbol_count
	symbol_count=$(echo "$symbols_data" | grep -c "^SYMBOL|" || true)
	if [[ "${OUTPUT_TSV:-false}" != "true" ]]; then
		info "  Found $symbol_count symbol(s)"
	fi

	# Process based on options
	if $OPT_VERIFY; then
		verify_file "$file" "$symbols_data"
	fi

	if $OPT_DOWNLOAD_DATASHEETS; then
		download_datasheets "$file" "$symbols_data" "$category"
	fi

	if $OPT_UPDATE_DIGIKEY; then
		process_digikey "$file" "$symbols_data"
	fi

	if $OPT_DELETE_DIGIKEY; then
		delete_digikey_info "$file" "$symbols_data"
	fi
}

# Run main
main "$@"
